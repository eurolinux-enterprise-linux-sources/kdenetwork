commit 831315276bdf93e03eb304016d3f1a068586cb49
Author: Olivier Goffart <ogoffart@kde.org>
Date:   Sat Feb 14 13:06:12 2009 +0100

    File transfer preview patch from Kopete

diff --git a/src/xmpp/xmpp-im/filetransfer.cpp b/src/xmpp/xmpp-im/filetransfer.cpp
index c5d1783..9d68502 100644
--- a/src/xmpp/xmpp-im/filetransfer.cpp
+++ b/src/xmpp/xmpp-im/filetransfer.cpp
@@ -56,6 +56,7 @@ public:
 	qlonglong size;
 	qlonglong sent;
 	QString desc;
+	QString preview;
 	bool rangeSupported;
 	qlonglong rangeOffset, rangeLength, length;
 	QString streamType;
@@ -123,13 +124,14 @@ void FileTransfer::setProxy(const Jid &proxy)
 	d->proxy = proxy;
 }
 
-void FileTransfer::sendFile(const Jid &to, const QString &fname, qlonglong size, const QString &desc)
+void FileTransfer::sendFile(const Jid &to, const QString &fname, qlonglong size, const QString &desc, const QString& preview)
 {
 	d->state = Requesting;
 	d->peer = to;
 	d->fname = fname;
 	d->size = size;
 	d->desc = desc;
+	d->preview = preview;
 	d->sender = true;
 	d->id = d->m->link(this);
 
@@ -137,7 +139,7 @@ void FileTransfer::sendFile(const Jid &to, const QString &fname, qlonglong size,
 	connect(d->ft, SIGNAL(finished()), SLOT(ft_finished()));
 	QStringList list;
 	list += "http://jabber.org/protocol/bytestreams";
-	d->ft->request(to, d->id, fname, size, desc, list);
+	d->ft->request(to, d->id, fname, size, desc, list,preview);
 	d->ft->go(true);
 }
 
@@ -190,6 +192,12 @@ QString FileTransfer::description() const
 	return d->desc;
 }
 
+
+QString XMPP::FileTransfer::preview() const
+{
+	return d->preview;
+}
+
 bool FileTransfer::rangeSupported() const
 {
 	return d->rangeSupported;
@@ -333,6 +341,7 @@ void FileTransfer::man_waitForAccept(const FTRequest &req)
 	d->fname = req.fname;
 	d->size = req.size;
 	d->desc = req.desc;
+	d->preview = req.preview;
 	d->rangeSupported = req.rangeSupported;
 }
 
@@ -486,7 +495,7 @@ JT_FT::~JT_FT()
 	delete d;
 }
 
-void JT_FT::request(const Jid &to, const QString &_id, const QString &fname, qlonglong size, const QString &desc, const QStringList &streamTypes)
+void JT_FT::request(const Jid &to, const QString &_id, const QString &fname, qlonglong size, const QString &desc, const QStringList &streamTypes, const QString& preview)
 {
 	QDomElement iq;
 	d->to = to;
@@ -505,6 +514,12 @@ void JT_FT::request(const Jid &to, const QString &_id, const QString &fname, qlo
 		de.appendChild(doc()->createTextNode(desc));
 		file.appendChild(de);
 	}
+	if(!preview.isEmpty()) {
+		QDomElement pr = doc()->createElement("preview");
+		pr.setAttribute("xmlns", "http://kopete.kde.org/protocol/file-preview");
+		pr.appendChild(doc()->createTextNode(preview));
+		file.appendChild(pr);
+	}
 	QDomElement range = doc()->createElement("range");
 	file.appendChild(range);
 	si.appendChild(file);
@@ -744,6 +759,11 @@ bool JT_PushFT::take(const QDomElement &e)
 	QDomElement de = file.elementsByTagName("desc").item(0).toElement();
 	if(!de.isNull())
 		desc = de.text();
+	
+	QString preview;
+	QDomElement pr = file.elementsByTagName("preview").item(0).toElement();
+	if(!pr.isNull())
+		preview= pr.text();
 
 	bool rangeSupported = false;
 	QDomElement range = file.elementsByTagName("range").item(0).toElement();
@@ -775,6 +795,7 @@ bool JT_PushFT::take(const QDomElement &e)
 	r.fname = fname;
 	r.size = size;
 	r.desc = desc;
+	r.preview = preview;
 	r.rangeSupported = rangeSupported;
 	r.streamTypes = streamTypes;
 
diff --git a/src/xmpp/xmpp-im/filetransfer.h b/src/xmpp/xmpp-im/filetransfer.h
index b002f44..b201c3d 100644
--- a/src/xmpp/xmpp-im/filetransfer.h
+++ b/src/xmpp/xmpp-im/filetransfer.h
@@ -53,7 +53,7 @@ namespace XMPP
 		void setProxy(const Jid &proxy);
 
 		// send
-		void sendFile(const Jid &to, const QString &fname, qlonglong size, const QString &desc);
+		void sendFile(const Jid &to, const QString &fname, qlonglong size, const QString &desc, const QString& preview=QString());
 		qlonglong offset() const;
 		qlonglong length() const;
 		int dataSizeNeeded() const;
@@ -64,6 +64,7 @@ namespace XMPP
 		QString fileName() const;
 		qlonglong fileSize() const;
 		QString description() const;
+		QString preview() const;
 		bool rangeSupported() const;
 		void accept(qlonglong offset=0, qlonglong length=0);
 
@@ -140,7 +141,7 @@ namespace XMPP
 		JT_FT(Task *parent);
 		~JT_FT();
 
-		void request(const Jid &to, const QString &id, const QString &fname, qlonglong size, const QString &desc, const QStringList &streamTypes);
+		void request(const Jid &to, const QString &id, const QString &fname, qlonglong size, const QString &desc, const QStringList &streamTypes, const QString &preview=QString());
 		qlonglong rangeOffset() const;
 		qlonglong rangeLength() const;
 		QString streamType() const;
@@ -160,6 +161,7 @@ namespace XMPP
 		QString fname;
 		qlonglong size;
 		QString desc;
+		QString preview;
 		bool rangeSupported;
 		QStringList streamTypes;
 	};
